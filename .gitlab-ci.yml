stages:          # List of stages for jobs, and their order of execution
  - push-image

variables:
  APP_VERSION: $CI_PIPELINE_ID
  DOCKER_REGISTRY: 100525915128.dkr.ecr.us-east-2.amazonaws.com
  APP_NAME: andersen-task-stage
  TAG: V1.0

.docker-create-image:
  stage: create
  image: docker:24.0.4
  services:
    - docker:24.0.4-dind
  script: 
    - docker build -t $DOCKER_REGISTRY/$APP_NAME:$TAG  .
    - docker image ls

docker-push-image:
  stage: push-image
  image: 
    name: $DOCKER_REGISTRY/$APP_NAME:$TAG
  services:
    - docker:24.0.4-dind
  script:
    - docker build -t $DOCKER_REGISTRY/$APP_NAME:$TAG  .
    - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - docker tag $DOCKER_REGISTRY/$APP_NAME:"$TAG" $DOCKER_REGISTRY/$APP_NAME:"$TAG"
    - docker push $DOCKER_REGISTRY/$APP_NAME:"$TAG"
